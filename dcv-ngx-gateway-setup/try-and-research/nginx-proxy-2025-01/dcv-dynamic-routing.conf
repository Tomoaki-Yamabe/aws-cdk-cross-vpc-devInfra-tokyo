# DCV Dynamic Agent Routing Configuration
# ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰Agentå¯¾å¿œ - å‹•çš„IPãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
# URLå½¢å¼: https://10.213.66.188:8443/<Agentã®IP>/
# ä¾‹: https://10.213.66.188:8443/10.150.248.180/ â†’ 10.150.248.180:8443
#     https://10.213.66.188:8443/10.150.248.136/ â†’ 10.150.248.136:8443

# WebSocket Upgrade Map
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 8443 ssl;
    http2 on;
    server_name _;

    # SSLè¨¼æ˜æ›¸è¨­å®š
    ssl_certificate /etc/dcv-connection-gateway/certs/dcv.crt;
    ssl_certificate_key /etc/dcv-connection-gateway/certs/dcv.key;
    
    # SSLæœ€é©åŒ–
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ãƒ­ã‚°è¨­å®š
    access_log /var/log/nginx/dcv-access.log;
    error_log /var/log/nginx/dcv-error.log;

    # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
    client_max_body_size 1G;
    client_body_timeout 60s;
    client_header_timeout 60s;

    # Agent IPæŠ½å‡ºç”¨ã®å¤‰æ•°è¨­å®š
    set $agent_ip "";

    # å‹•çš„Agent IPãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    # ãƒ‘ã‚¿ãƒ¼ãƒ³: /10.150.248.180/ ã¾ãŸã¯ /192.168.1.100/ ãªã©
    location ~ ^/([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})(/.*)?$ {
        # Agent IPã‚’å¤‰æ•°ã«è¨­å®š
        set $agent_ip $1;
        set $agent_path $2;
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ã‚’è¨­å®šï¼ˆç©ºã®å ´åˆã¯/ï¼‰
        if ($agent_path = "") {
            set $agent_path "/";
        }
        
        # Agent IPã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆ10.150.248.x ã¾ãŸã¯ 192.168.x.x ã®ã¿è¨±å¯ï¼‰
        if ($agent_ip !~ "^(10\.150\.248\.|192\.168\.)") {
            return 403 "Forbidden: Invalid Agent IP range";
        }
        
        # å‹•çš„ãƒ—ãƒ­ã‚­ã‚·è¨­å®š
        proxy_pass https://$agent_ip:8443$agent_path;
        proxy_ssl_verify off;
        proxy_http_version 1.1;
        
        # WebSocketå¯¾å¿œãƒ˜ãƒƒãƒ€ãƒ¼
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # æ¨™æº–ãƒ˜ãƒƒãƒ€ãƒ¼
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Agent-IP $agent_ip;
        
        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        proxy_connect_timeout 10s;  # çŸ­ã‚ã«è¨­å®šï¼ˆã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰Agentå¯¾å¿œï¼‰
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç„¡åŠ¹åŒ–
        proxy_buffering off;
        tcp_nodelay on;
        proxy_socket_keepalive on;
        
        # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        proxy_intercept_errors on;
        error_page 502 503 504 = @agent_unavailable;
    }

    # Agentåˆ©ç”¨ä¸å¯æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸
    location @agent_unavailable {
        return 503 '<!DOCTYPE html>
<html>
<head>
    <title>Agent Unavailable</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; background: #f8f9fa; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .error { color: #dc3545; text-align: center; }
        .info { color: #6c757d; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="error">
            <h1>ğŸš« Agent Unavailable</h1>
            <p>æŒ‡å®šã•ã‚ŒãŸAgent (<strong>$agent_ip</strong>) ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚</p>
        </div>
        <div class="info">
            <h3>è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :</h3>
            <ul>
                <li>AgentãŒèµ·å‹•ã—ã¦ã„ãªã„</li>
                <li>DCVã‚µãƒ¼ãƒ“ã‚¹ãŒåœæ­¢ã—ã¦ã„ã‚‹</li>
                <li>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å•é¡Œ</li>
                <li>AgentãŒå‰Šé™¤ã•ã‚ŒãŸ</li>
            </ul>
            <p><strong>è§£æ±ºæ–¹æ³•:</strong> ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§Agentä¸€è¦§ã‚’æ›´æ–°ã—ã€åˆ©ç”¨å¯èƒ½ãªAgentã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    location /health {
        access_log off;
        return 200 '{"status":"ok","service":"dcv-gateway","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }

    # API: æ¥ç¶šå¯èƒ½ãªAgentä¸€è¦§ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    location /api/agents/available {
        # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€Agentã®ç”Ÿå­˜ç¢ºèªã‚’è¡Œã†
        return 200 '{
            "message": "Dynamic routing enabled",
            "usage": "https://10.213.66.188:8443/<AGENT_IP>/",
            "examples": [
                "https://10.213.66.188:8443/10.150.248.180/",
                "https://10.213.66.188:8443/10.150.248.136/"
            ],
            "allowed_ranges": [
                "10.150.248.x",
                "192.168.x.x"
            ]
        }';
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
    }

    # ãƒ«ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®æ¡ˆå†…ãƒšãƒ¼ã‚¸
    location = / {
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>DCV Dynamic Gateway</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .usage { background: #e9ecef; padding: 20px; border-radius: 5px; margin: 20px 0; }
        .example { background: #d4edda; padding: 15px; border-radius: 5px; margin: 10px 0; }
        code { background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ DCV Dynamic Gateway</h1>
        <p style="text-align: center; color: #666;">ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰Agentå¯¾å¿œã®å‹•çš„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤</p>
        
        <div class="usage">
            <h3>ğŸ“‹ ä½¿ç”¨æ–¹æ³•</h3>
            <p>ä»¥ä¸‹ã®å½¢å¼ã§Agentã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼š</p>
            <p><code>https://10.213.66.188:8443/&lt;Agentã®IP&gt;/</code></p>
        </div>
        
        <div class="example">
            <h4>ğŸ’¡ ä¾‹:</h4>
            <ul>
                <li><code>https://10.213.66.188:8443/10.150.248.180/</code> â†’ Agent1</li>
                <li><code>https://10.213.66.188:8443/10.150.248.136/</code> â†’ Agent2</li>
                <li><code>https://10.213.66.188:8443/192.168.1.100/</code> â†’ ã‚«ã‚¹ã‚¿ãƒ Agent</li>
            </ul>
        </div>
        
        <div class="usage">
            <h3>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
            <p>è¨±å¯ã•ã‚ŒãŸIPãƒ¬ãƒ³ã‚¸:</p>
            <ul>
                <li><code>10.150.248.x</code> (å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯)</li>
                <li><code>192.168.x.x</code> (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯)</li>
            </ul>
        </div>
        
        <div class="usage">
            <h3>ğŸ”§ API</h3>
            <ul>
                <li><a href="/health">ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</a>: <code>/health</code></li>
                <li><a href="/api/agents/available">Agentæƒ…å ±</a>: <code>/api/agents/available</code></li>
            </ul>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # ãã®ä»–ã®ãƒ‘ã‚¹ã¯404
    location / {
        return 404 '<!DOCTYPE html>
<html>
<head><title>404 Not Found</title></head>
<body>
    <h1>404 Not Found</h1>
    <p>æ­£ã—ã„å½¢å¼: <code>https://10.213.66.188:8443/&lt;Agentã®IP&gt;/</code></p>
    <p><a href="/">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a></p>
</body>
</html>';
        add_header Content-Type text/html;
    }
}

# WebSocket Upgrade Map
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}