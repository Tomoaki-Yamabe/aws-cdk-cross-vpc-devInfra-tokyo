# DCV Path-based Routing Configuration
# URL形式: https://10.213.66.188:8443/10.150.248.180/ (Agent1)
#          https://10.213.66.188:8443/10.150.248.136/ (Agent2)

server {
    listen 8443 ssl http2;
    server_name _;

    # SSL証明書設定
    ssl_certificate /etc/dcv-connection-gateway/certs/dcv.crt;
    ssl_certificate_key /etc/dcv-connection-gateway/certs/dcv.key;
    
    # SSL最適化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ログ設定
    access_log /var/log/nginx/dcv-access.log;
    error_log /var/log/nginx/dcv-error.log;

    # クライアント設定
    client_max_body_size 1G;
    client_body_timeout 60s;
    client_header_timeout 60s;

    # Agent選択ページ（ルート）
    location = / {
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>DCV Agent Selection</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .agent-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .agent-card { border: 2px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; transition: all 0.3s; }
        .agent-card:hover { border-color: #007bff; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,123,255,0.2); }
        .agent-button { display: inline-block; background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; font-weight: bold; margin-top: 10px; }
        .agent-button:hover { background: #0056b3; }
        .status { font-size: 12px; color: #666; margin-top: 5px; }
        .online { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🖥️ DCV Agent Selection</h1>
        <p style="text-align: center; color: #666;">接続したいAgentを選択してください</p>
        
        <div class="agent-list">
            <div class="agent-card">
                <h3>Agent1 - Ubuntu Desktop</h3>
                <p><strong>IP:</strong> 10.150.248.180</p>
                <p><strong>Type:</strong> Console Session</p>
                <div class="status online">● Online</div>
                <a href="/10.150.248.180/" class="agent-button">Connect to Agent1</a>
            </div>
            
            <div class="agent-card">
                <h3>Agent2 - Development</h3>
                <p><strong>IP:</strong> 10.150.248.136</p>
                <p><strong>Type:</strong> Console Session</p>
                <div class="status online">● Online</div>
                <a href="/10.150.248.136/" class="agent-button">Connect to Agent2</a>
            </div>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #e9ecef; border-radius: 5px;">
            <h4>📋 使用方法</h4>
            <ul>
                <li>上記のボタンをクリックして、希望するAgentに接続</li>
                <li>各AgentでDCVセッションが自動起動されています</li>
                <li>直接URL指定も可能: <code>/10.150.248.180/</code> または <code>/10.150.248.136/</code></li>
            </ul>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # Agent1 (10.150.248.180) へのルーティング
    location /10.150.248.180/ {
        proxy_pass https://10.150.248.180:8443/;
        proxy_ssl_verify off;
        proxy_http_version 1.1;
        
        # WebSocket対応ヘッダー
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # 標準ヘッダー
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # タイムアウト設定
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # バッファリング無効化
        proxy_buffering off;
        tcp_nodelay on;
        proxy_socket_keepalive on;
    }

    # Agent2 (10.150.248.136) へのルーティング
    location /10.150.248.136/ {
        proxy_pass https://10.150.248.136:8443/;
        proxy_ssl_verify off;
        proxy_http_version 1.1;
        
        # WebSocket対応ヘッダー
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # 標準ヘッダー
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # タイムアウト設定
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # バッファリング無効化
        proxy_buffering off;
        tcp_nodelay on;
        proxy_socket_keepalive on;
    }

    # API エンドポイント（Agent一覧取得用）
    location /api/agents {
        return 200 '{
            "agents": [
                {
                    "id": "agent1",
                    "name": "Agent1 - Ubuntu Desktop",
                    "ip": "10.150.248.180",
                    "status": "online",
                    "type": "console",
                    "url": "/10.150.248.180/"
                },
                {
                    "id": "agent2",
                    "name": "Agent2 - Development",
                    "ip": "10.150.248.136",
                    "status": "online",
                    "type": "console",
                    "url": "/10.150.248.136/"
                }
            ]
        }';
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
    }
}

# WebSocket Upgrade Map
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}