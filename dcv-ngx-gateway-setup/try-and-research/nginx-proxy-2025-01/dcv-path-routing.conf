# DCV Path-based Routing Configuration
# URLå½¢å¼: https://10.213.66.188:8443/10.150.248.180/ (Agent1)
#          https://10.213.66.188:8443/10.150.248.136/ (Agent2)

server {
    listen 8443 ssl http2;
    server_name _;

    # SSLè¨¼æ˜æ›¸è¨­å®š
    ssl_certificate /etc/dcv-connection-gateway/certs/dcv.crt;
    ssl_certificate_key /etc/dcv-connection-gateway/certs/dcv.key;
    
    # SSLæœ€é©åŒ–
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ãƒ­ã‚°è¨­å®š
    access_log /var/log/nginx/dcv-access.log;
    error_log /var/log/nginx/dcv-error.log;

    # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
    client_max_body_size 1G;
    client_body_timeout 60s;
    client_header_timeout 60s;

    # Agenté¸æŠãƒšãƒ¼ã‚¸ï¼ˆãƒ«ãƒ¼ãƒˆï¼‰
    location = / {
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>DCV Agent Selection</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .agent-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .agent-card { border: 2px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; transition: all 0.3s; }
        .agent-card:hover { border-color: #007bff; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,123,255,0.2); }
        .agent-button { display: inline-block; background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; font-weight: bold; margin-top: 10px; }
        .agent-button:hover { background: #0056b3; }
        .status { font-size: 12px; color: #666; margin-top: 5px; }
        .online { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¥ï¸ DCV Agent Selection</h1>
        <p style="text-align: center; color: #666;">æ¥ç¶šã—ãŸã„Agentã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        
        <div class="agent-list">
            <div class="agent-card">
                <h3>Agent1 - Ubuntu Desktop</h3>
                <p><strong>IP:</strong> 10.150.248.180</p>
                <p><strong>Type:</strong> Console Session</p>
                <div class="status online">â— Online</div>
                <a href="/10.150.248.180/" class="agent-button">Connect to Agent1</a>
            </div>
            
            <div class="agent-card">
                <h3>Agent2 - Development</h3>
                <p><strong>IP:</strong> 10.150.248.136</p>
                <p><strong>Type:</strong> Console Session</p>
                <div class="status online">â— Online</div>
                <a href="/10.150.248.136/" class="agent-button">Connect to Agent2</a>
            </div>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #e9ecef; border-radius: 5px;">
            <h4>ğŸ“‹ ä½¿ç”¨æ–¹æ³•</h4>
            <ul>
                <li>ä¸Šè¨˜ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€å¸Œæœ›ã™ã‚‹Agentã«æ¥ç¶š</li>
                <li>å„Agentã§DCVã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè‡ªå‹•èµ·å‹•ã•ã‚Œã¦ã„ã¾ã™</li>
                <li>ç›´æ¥URLæŒ‡å®šã‚‚å¯èƒ½: <code>/10.150.248.180/</code> ã¾ãŸã¯ <code>/10.150.248.136/</code></li>
            </ul>
        </div>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # Agent1 (10.150.248.180) ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    location /10.150.248.180/ {
        proxy_pass https://10.150.248.180:8443/;
        proxy_ssl_verify off;
        proxy_http_version 1.1;
        
        # WebSocketå¯¾å¿œãƒ˜ãƒƒãƒ€ãƒ¼
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # æ¨™æº–ãƒ˜ãƒƒãƒ€ãƒ¼
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç„¡åŠ¹åŒ–
        proxy_buffering off;
        tcp_nodelay on;
        proxy_socket_keepalive on;
    }

    # Agent2 (10.150.248.136) ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    location /10.150.248.136/ {
        proxy_pass https://10.150.248.136:8443/;
        proxy_ssl_verify off;
        proxy_http_version 1.1;
        
        # WebSocketå¯¾å¿œãƒ˜ãƒƒãƒ€ãƒ¼
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # æ¨™æº–ãƒ˜ãƒƒãƒ€ãƒ¼
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç„¡åŠ¹åŒ–
        proxy_buffering off;
        tcp_nodelay on;
        proxy_socket_keepalive on;
    }

    # API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆAgentä¸€è¦§å–å¾—ç”¨ï¼‰
    location /api/agents {
        return 200 '{
            "agents": [
                {
                    "id": "agent1",
                    "name": "Agent1 - Ubuntu Desktop",
                    "ip": "10.150.248.180",
                    "status": "online",
                    "type": "console",
                    "url": "/10.150.248.180/"
                },
                {
                    "id": "agent2",
                    "name": "Agent2 - Development",
                    "ip": "10.150.248.136",
                    "status": "online",
                    "type": "console",
                    "url": "/10.150.248.136/"
                }
            ]
        }';
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
    }
}

# WebSocket Upgrade Map
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}