# Architecture Decision Record (ADR): AWS DCV nginx ãƒ—ãƒ­ã‚­ã‚·å®Ÿè£…

**ADRç•ªå·**: ADR-001  
**æ—¥ä»˜**: 2025-08-07  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æ‰¿èªæ¸ˆã¿  
**æ±ºå®šè€…**: é–‹ç™ºãƒãƒ¼ãƒ   

## ğŸ“‹ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

AWS DCV (Desktop Cloud Visualization) ç’°å¢ƒã«ãŠã„ã¦ã€å‰å›å®Ÿè£…ã—ãŸDCV Connection Gateway + Session Resolveræ–¹å¼ã§WebSocketèªè¨¼404ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€å®Ÿç”¨çš„ãªæ¥ç¶šãŒå›°é›£ãªçŠ¶æ³ã§ã—ãŸã€‚

### å‰å›ã®å•é¡Œç‚¹
- WebSocketèªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (`/auth`) ãŒ404ã‚¨ãƒ©ãƒ¼
- Session Manager Brokerã®WebSocketåˆ¶é™ï¼ˆAWSå…¬å¼ã®è¨­è¨ˆä¸Šã®åˆ¶é™ï¼‰
- è¤‡é›‘ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚‹ä¿å®ˆæ€§ã®ä½ä¸‹
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å›°é›£ã•

## ğŸ¯ æ±ºå®šäº‹é …

**nginx ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·æ–¹å¼ã‚’æ¡ç”¨ã—ã€Session Manager Brokerã‚’å®Œå…¨ã«ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹**

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é¸æŠç†ç”±

1. **å˜ç´”æ€§**: è¤‡é›‘ãªSession Resolverä¸è¦
2. **WebSocketå®Œå…¨å¯¾å¿œ**: nginxã®æ¨™æº–æ©Ÿèƒ½ã§è§£æ±º
3. **ä¿å®ˆæ€§**: ä¸€èˆ¬çš„ãªnginxè¨­å®šã«ã‚ˆã‚‹é‹ç”¨å®¹æ˜“æ€§
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ç›´æ¥ãƒ—ãƒ­ã‚­ã‚·ã«ã‚ˆã‚‹ä½é…å»¶
5. **å®Ÿç¸¾**: nginxã®è±Šå¯Œãªé‹ç”¨å®Ÿç¸¾

## ğŸ—ï¸ å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ç¾åœ¨ã®æ§‹æˆ

```
[Browser/Client] 
    â†“ HTTPS (port 8443)
[VPC Endpoint] vpce-02c333708db2e72b7-o2x6rrvy.vpce-svc-039cee5d9ee693914.ap-northeast-1.vpce.amazonaws.com:8443
    â†“ PrivateLink
[nginx Reverse Proxy] (10.150.248.162:8443) â† Gateway Server
    â†“ HTTPS Proxy (WebSocketå¯¾å¿œ)
[DCV Server] (10.150.248.180:8443) â† Agent1 (ç¾åœ¨ã®æ¥ç¶šå…ˆ)
    â†“ Direct Session Access
[Ubuntu Desktop Session] (console)
```

### æ¥ç¶šå…ˆç®¡ç†

#### ç¾åœ¨ã®æ¥ç¶šå…ˆ
- **Agent1**: 10.150.248.180:8443 (Ubuntu Desktop)
- **Agent2**: 10.150.248.136:8443 (åˆ©ç”¨å¯èƒ½ã ãŒæœªè¨­å®š)

#### æ¥ç¶šå…ˆåˆ‡ã‚Šæ›¿ãˆæ–¹æ³•

**æ–¹æ³•1: nginxè¨­å®šå¤‰æ›´ã«ã‚ˆã‚‹åˆ‡ã‚Šæ›¿ãˆ**
```bash
# Agent2ã«åˆ‡ã‚Šæ›¿ãˆã‚‹å ´åˆ
sudo sed -i 's/server 10.150.248.180:8443;/server 10.150.248.136:8443;/' /etc/nginx/conf.d/dcv-proxy.conf
sudo nginx -s reload
```

**æ–¹æ³•2: è² è·åˆ†æ•£è¨­å®šï¼ˆæ¨å¥¨ï¼‰**
```nginx
upstream dcv_backend {
    server 10.150.248.180:8443 weight=1;  # Agent1
    server 10.150.248.136:8443 weight=1 backup;  # Agent2 (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
    keepalive 32;
}
```

**æ–¹æ³•3: ãƒ‘ã‚¹åˆ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆå°†æ¥å®Ÿè£…ï¼‰**
```nginx
location /agent1/ {
    proxy_pass https://10.150.248.180:8443/;
}
location /agent2/ {
    proxy_pass https://10.150.248.136:8443/;
}
```

## ğŸ“Š æŠ€è¡“çš„è©³ç´°

### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å½¹å‰² | è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« |
|---------------|------|-------------|
| **nginx** | ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ãƒ»WebSocketå¯¾å¿œ | `/etc/nginx/conf.d/dcv-proxy.conf` |
| **DCV Server** | ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ä»®æƒ³åŒ– | `/etc/dcv/dcv.conf` |
| **SSLè¨¼æ˜æ›¸** | HTTPSæš—å·åŒ– | `/etc/dcv-connection-gateway/certs/` |
| **ãƒ­ã‚°ç›£è¦–** | é‹ç”¨ç›£è¦– | `/usr/local/bin/dcv-monitor.sh` |

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™

| æŒ‡æ¨™ | æ¸¬å®šå€¤ | ç›®æ¨™å€¤ |
|------|--------|--------|
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ | 0.756ms | < 2ms |
| HTTPå¿œç­”æ™‚é–“ | 9.066ms | < 50ms |
| SSLæ¥ç¶šæ™‚é–“ | 4.846ms | < 10ms |
| å¯ç”¨æ€§ | 99.9%+ | > 99.5% |

## ğŸš€ ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆè¨ˆç”»

### Phase 1: åŸºæœ¬æ©Ÿèƒ½å¼·åŒ– (1-2é€±é–“)

#### 1.1 Agent2ç’°å¢ƒæ•´å‚™
```bash
# Agent2ã§ã®ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ç’°å¢ƒè¨­å®š
ssh -i "tom.pem" ubuntu@10.213.66.188 -p 60001
sudo systemctl set-default graphical.target
sudo systemctl start gdm
sudo dcv create-session --type=console --owner=ubuntu desktop
```

#### 1.2 è² è·åˆ†æ•£è¨­å®š
- nginx upstreamè¨­å®šã§Agent1/Agent2ã®è² è·åˆ†æ•£
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã®å®Ÿè£…
- è‡ªå‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼è¨­å®š

#### 1.3 ç›£è¦–å¼·åŒ–
- Prometheus/Grafanaçµ±åˆ
- ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ§‹ç¯‰

### Phase 2: é«˜å¯ç”¨æ€§å®Ÿè£… (2-4é€±é–“)

#### 2.1 ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾å¿œ
```nginx
upstream dcv_backend {
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶­æŒã®ãŸã‚ã®ip_hash
    ip_hash;
    
    server 10.150.248.180:8443 max_fails=3 fail_timeout=30s;
    server 10.150.248.136:8443 max_fails=3 fail_timeout=30s;
    
    keepalive 32;
}
```

#### 2.2 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†API
- RESTful APIã«ã‚ˆã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- å‹•çš„ãªæ¥ç¶šå…ˆåˆ‡ã‚Šæ›¿ãˆ
- ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç›£è¦–

#### 2.3 è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
# ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹
#!/bin/bash
switch_to_agent() {
    local agent_ip=$1
    sudo sed -i "s/server [0-9.]*:8443;/server $agent_ip:8443;/" /etc/nginx/conf.d/dcv-proxy.conf
    sudo nginx -s reload
    echo "Switched to agent: $agent_ip"
}
```

### Phase 3: ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºæ©Ÿèƒ½ (1-2ãƒ¶æœˆ)

#### 3.1 èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 
- LDAP/Active Directoryçµ±åˆ
- RBAC (Role-Based Access Control)
- SSO (Single Sign-On) å¯¾å¿œ

#### 3.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
- WAF (Web Application Firewall) çµ±åˆ
- VPNçµ±åˆ
- è¨¼æ˜æ›¸è‡ªå‹•æ›´æ–° (Let's Encrypt)

#### 3.3 ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
- Auto Scaling Groupçµ±åˆ
- å‹•çš„Agentè¿½åŠ /å‰Šé™¤
- ã‚³ãƒ³ãƒ†ãƒŠåŒ– (Docker/Kubernetes)

## ğŸ”§ é‹ç”¨æ‰‹é †æ›¸

### æ—¥å¸¸é‹ç”¨

#### æ¥ç¶šå…ˆç¢ºèª
```bash
# ç¾åœ¨ã®æ¥ç¶šå…ˆç¢ºèª
grep "server.*:8443" /etc/nginx/conf.d/dcv-proxy.conf

# ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
ssh -i "tom.pem" ubuntu@10.213.66.188 "sudo dcv list-sessions"
```

#### æ¥ç¶šå…ˆåˆ‡ã‚Šæ›¿ãˆ
```bash
# Agent1 â†’ Agent2
sudo sed -i 's/10.150.248.180/10.150.248.136/' /etc/nginx/conf.d/dcv-proxy.conf
sudo nginx -s reload

# Agent2 â†’ Agent1
sudo sed -i 's/10.150.248.136/10.150.248.180/' /etc/nginx/conf.d/dcv-proxy.conf
sudo nginx -s reload
```

#### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
```bash
# ãƒ­ã‚°ç¢ºèª
sudo /usr/local/bin/dcv-monitor.sh

# è¨­å®šãƒ†ã‚¹ãƒˆ
sudo nginx -t

# ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
sudo systemctl restart nginx
```

### ç·Šæ€¥æ™‚å¯¾å¿œ

#### æ¥ç¶šä¸å¯æ™‚ã®å¯¾å¿œæ‰‹é †
1. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèª**: `ping 10.150.248.180`
2. **ã‚µãƒ¼ãƒ“ã‚¹ç¢ºèª**: `sudo systemctl status nginx dcvserver`
3. **ãƒ­ã‚°ç¢ºèª**: `sudo tail -f /var/log/nginx/dcv-error.log`
4. **ä»£æ›¿Agentåˆ‡ã‚Šæ›¿ãˆ**: ä¸Šè¨˜åˆ‡ã‚Šæ›¿ãˆæ‰‹é †å®Ÿè¡Œ
5. **ã‚»ãƒƒã‚·ãƒ§ãƒ³å†ä½œæˆ**: `sudo dcv close-session console && sudo dcv create-session --type=console --owner=ubuntu console`

## ğŸ“ˆ æˆåŠŸæŒ‡æ¨™

### æŠ€è¡“æŒ‡æ¨™
- **å¯ç”¨æ€§**: 99.9%ä»¥ä¸Š
- **å¿œç­”æ™‚é–“**: 50msä»¥ä¸‹
- **WebSocketæ¥ç¶šæˆåŠŸç‡**: 99%ä»¥ä¸Š
- **åŒæ™‚æ¥ç¶šæ•°**: 10ã‚»ãƒƒã‚·ãƒ§ãƒ³ä»¥ä¸Š

### é‹ç”¨æŒ‡æ¨™
- **MTTR (Mean Time To Recovery)**: 5åˆ†ä»¥ä¸‹
- **ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“**: 10åˆ†ä»¥ä¸‹
- **è¨­å®šå¤‰æ›´æ™‚é–“**: 2åˆ†ä»¥ä¸‹

## ğŸ”„ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚¯ãƒ«

### å®šæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼
- **é€±æ¬¡**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ç¢ºèª
- **æœˆæ¬¡**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- **å››åŠæœŸ**: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¦‹ç›´ã—

### ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆåˆ¤æ–­åŸºæº–
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹**: å¿œç­”æ™‚é–“50msè¶…é
- **å¯ç”¨æ€§ä½ä¸‹**: 99%ã‚’ä¸‹å›ã‚‹
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶å¤‰æ›´**: æ–°ã—ã„è„…å¨å¯¾å¿œ
- **ãƒ“ã‚¸ãƒã‚¹è¦ä»¶å¤‰æ›´**: æ–°æ©Ÿèƒ½è¦æ±‚

## ğŸ“š å‚è€ƒè³‡æ–™

### æŠ€è¡“æ–‡æ›¸
- [nginx WebSocket ãƒ—ãƒ­ã‚­ã‚·è¨­å®š](http://nginx.org/en/docs/http/websocket.html)
- [AWS DCV ç®¡ç†è€…ã‚¬ã‚¤ãƒ‰](https://docs.aws.amazon.com/dcv/latest/adminguide/)
- [AWS PrivateLink ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/vpc/latest/privatelink/)

### é–¢é€£ADR
- ADR-002: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–è¨ˆç”» (äºˆå®š)
- ADR-003: ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å®Ÿè£… (äºˆå®š)
- ADR-004: ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­è¨ˆ (äºˆå®š)

---

**æ‰¿èªè€…**: é–‹ç™ºãƒãƒ¼ãƒ   
**å®Ÿè£…è€…**: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…  
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼**: 2025-08-21  

**å¤‰æ›´å±¥æ­´**:
- 2025-08-07: åˆç‰ˆä½œæˆã€nginx ãƒ—ãƒ­ã‚­ã‚·æ–¹å¼æ¡ç”¨æ±ºå®š