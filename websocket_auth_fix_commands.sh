#!/bin/bash
# WebSocketèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆ/auth 404ï¼‰è§£æ±ºæ‰‹é †
# å®Ÿè¡Œæ—¥æ™‚: 2025å¹´8æœˆ5æ—¥

echo "=== WebSocketèªè¨¼ã‚¨ãƒ©ãƒ¼è§£æ±ºæ‰‹é † ==="
echo "å®Ÿè¡Œé–‹å§‹: $(date)"

echo ""
echo "ğŸ”§ æ‰‹é †1: DCV Serverè¨­å®šã®ä¿®æ­£ï¼ˆAgentå´: 10.150.248.180ï¼‰"
echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’Agentå´ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š"
echo ""
echo "# 1. Brokerè¨¼æ˜æ›¸ã®å­˜åœ¨ç¢ºèª"
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo ls -la /etc/dcv-session-manager-agent/broker_cert.pem\""
echo ""
echo "# 2. è¨¼æ˜æ›¸ãŒå­˜åœ¨ã—ãªã„å ´åˆã€Gatewayå´ã‹ã‚‰ã‚³ãƒ”ãƒ¼"
echo "echo 'è¨¼æ˜æ›¸ã‚³ãƒ”ãƒ¼ãŒå¿…è¦ãªå ´åˆ:'"
echo "ssh -i \"tom.pem\" ec2-user@10.213.66.188 -p 50000 \"sudo cat /var/lib/dcvsmbroker/security/dcvsmbroker_ca.pem\" > broker_cert.pem"
echo "scp -i \"tom.pem\" broker_cert.pem ubuntu@10.213.66.188:/tmp/"
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo mv /tmp/broker_cert.pem /etc/dcv-session-manager-agent/broker_cert.pem\""
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo chown dcv:dcv /etc/dcv-session-manager-agent/broker_cert.pem\""
echo ""
echo "# 3. DCV Serverè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo cp /etc/dcv/dcv.conf /etc/dcv/dcv.conf.backup-$(date +%Y%m%d-%H%M%S)\""
echo ""
echo "# 4. ä¿®æ­£ã•ã‚ŒãŸDCV Serverè¨­å®šã®é©ç”¨"
echo "cat << 'EOF' > dcv_server_fixed.conf"
echo "[security]"
echo "# Session Managerçµ±åˆç”¨ã®èªè¨¼è¨­å®š"
echo "auth-token-verifier = \"https://10.150.248.162:8445/agent/validate-authentication-token\""
echo "ca-file = \"/etc/dcv-session-manager-agent/broker_cert.pem\""
echo ""
echo "# Originåˆ¶å¾¡è¨­å®šï¼ˆHTTP 407ã‚¨ãƒ©ãƒ¼è§£æ±ºæ¸ˆã¿ï¼‰"
echo "allowed-http-host-regex = \"^(10\\.213\\.66\\.188|vpce-.*\\.vpce\\.amazonaws\\.com)$\""
echo "allowed-ws-origin-regex = \"^https://(10\\.213\\.66\\.188|vpce-.*\\.vpce\\.amazonaws\\.com)(:[0-9]+)?$\""
echo ""
echo "[session-management]"
echo "# ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†è¨­å®š"
echo "create-session = true"
echo ""
echo "[display]"
echo "# ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤è¨­å®š"
echo "target-fps = 25"
echo ""
echo "[connectivity]"
echo "# æ¥ç¶šè¨­å®š"
echo "enable-quic-frontend = true"
echo ""
echo "[log]"
echo "# ãƒ­ã‚°è¨­å®š"
echo "level = \"info\""
echo "EOF"
echo ""
echo "scp -i \"tom.pem\" dcv_server_fixed.conf ubuntu@10.213.66.188:/tmp/"
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo mv /tmp/dcv_server_fixed.conf /etc/dcv/dcv.conf\""
echo ""

echo "ğŸ”§ æ‰‹é †2: DCV Serverã‚µãƒ¼ãƒ“ã‚¹ã®å†èµ·å‹•"
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo systemctl stop dcvserver\""
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo systemctl start dcvserver\""
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo systemctl status dcvserver --no-pager\""
echo ""

echo "ğŸ”§ æ‰‹é †3: Session Manager Agentã®å†èµ·å‹•"
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo systemctl restart dcv-session-manager-agent\""
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo systemctl status dcv-session-manager-agent --no-pager\""
echo ""

echo "ğŸ”§ æ‰‹é †4: è¨­å®šç¢ºèª"
echo "# DCVè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª"
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo cat /etc/dcv/dcv.conf\""
echo ""
echo "# è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª"
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo ls -la /etc/dcv-session-manager-agent/broker_cert.pem\""
echo ""

echo "ğŸ”§ æ‰‹é †5: æ¥ç¶šãƒ†ã‚¹ãƒˆ"
echo "# Session Resolverå‹•ä½œç¢ºèª"
echo "ssh -i \"tom.pem\" ec2-user@10.213.66.188 -p 50000 \"curl -k -X POST 'https://127.0.0.1:8447/resolveSession?sessionId=console&transport=HTTP&clientIpAddress=10.213.66.188'\""
echo ""
echo "# VPC EndpointçµŒç”±ã§ã®HTTPæ¥ç¶šç¢ºèª"
echo "curl --noproxy '*' -k https://vpce-02c333708db2e72b7-o2x6rrvy.vpce-svc-039cee5d9ee693914.ap-northeast-1.vpce.amazonaws.com:8443/?sessionId=console"
echo ""
echo "# Agentç›´æ¥æ¥ç¶šï¼ˆ50001ãƒãƒ¼ãƒˆï¼‰ã§ã®ç¢ºèª"
echo "curl --noproxy '*' -k https://10.213.66.188:50001/?sessionId=console"
echo ""

echo "ğŸ”§ æ‰‹é †6: ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ"
echo "ä»¥ä¸‹ã®URLã§ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼š"
echo "1. VPC EndpointçµŒç”±: https://vpce-02c333708db2e72b7-o2x6rrvy.vpce-svc-039cee5d9ee693914.ap-northeast-1.vpce.amazonaws.com:8443/?sessionId=console"
echo "2. Agentç›´æ¥æ¥ç¶š: https://10.213.66.188:50001/?sessionId=console"
echo ""
echo "æœŸå¾…ã•ã‚Œã‚‹çµæœ:"
echo "- DCVãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹"
echo "- WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼ˆ/auth 404ï¼‰ãŒè§£æ¶ˆã•ã‚Œã‚‹"
echo "- Ubuntuãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã‚‹"
echo ""

echo "ğŸ”§ æ‰‹é †7: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨ãƒ­ã‚°ç¢ºèª"
echo "# DCV Serverãƒ­ã‚°"
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo journalctl -u dcvserver -n 50 --no-pager\""
echo ""
echo "# Session Manager Agentãƒ­ã‚°"
echo "ssh -i \"tom.pem\" ubuntu@10.213.66.188 \"sudo journalctl -u dcv-session-manager-agent -n 50 --no-pager\""
echo ""
echo "# Connection Gatewayãƒ­ã‚°"
echo "ssh -i \"tom.pem\" ec2-user@10.213.66.188 -p 50000 \"sudo journalctl -u dcv-connection-gateway -n 50 --no-pager\""
echo ""

echo "å®Ÿè¡Œå®Œäº†: $(date)"
echo "=== WebSocketèªè¨¼ã‚¨ãƒ©ãƒ¼è§£æ±ºæ‰‹é †å®Œäº† ==="